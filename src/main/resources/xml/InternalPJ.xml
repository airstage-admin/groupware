<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.groupware.dao.InternalProjectWorkDao">

    <select id="selectInternalProjectWorkTime" resultType="com.groupware.dto.InternalPJDto">
        SELECT 
            u.employee_no AS employeeNo, 
            u.user_name AS username, 
            COALESCE(SUM(T2.rounded_work_time_h), 0) AS totalHours
        FROM users u 
        INNER JOIN ( 
            SELECT 
                T1.user_id, 
                (FLOOR( T1.net_work_minutes_day / 15 ) * 15) / 60.0 AS rounded_work_time_h
            FROM (
                SELECT 
                    a.user_id, 
                    a.working_day, 
                    SUM( (TIME_TO_SEC(a.clock_out) - TIME_TO_SEC(a.clock_in)) / 60 - (TIME_TO_SEC(COALESCE(a.break_time, '00:00:00')) / 60) - (TIME_TO_SEC(COALESCE(a.night_break_time, '00:00:00')) / 60) ) AS net_work_minutes_day
                FROM attendance a 
                WHERE DATE_FORMAT(a.working_day, '%Y-%m') = #{targetMonth} 
                  AND a.delflg = 0 
                  AND a.clock_in IS NOT NULL AND a.clock_in != '00:00:00' 
                  AND a.clock_out IS NOT NULL AND a.clock_out != '00:00:00' 
                  AND vacation_category = 18
                GROUP BY a.user_id, a.working_day
            ) AS T1
        ) AS T2 ON u.id = T2.user_id 
        WHERE u.delflg = 0 AND u.department != 1 
        GROUP BY u.id, u.employee_no, u.user_name 
        ORDER BY u.employee_no ASC
    </select>

</mapper>